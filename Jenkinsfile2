pipeline {
  agent any
  options { skipDefaultCheckout(true) }          // we control all checkouts
  triggers { pollSCM('H/5 * * * *') }

  stages {
    stage('Checkout Jenkinsfile repo') {
      steps { checkout scm }
    }

    stage('Fetch app (nodejs-goof)') {
      steps {
        dir('app') {
          // IMPORTANT: use 'main' not 'master'
          git branch: 'main', url: 'https://github.com/snyk-labs/nodejs-goof.git'
          // (optional) shallow clone for speed:
          // checkout([$class: 'GitSCM', branches: [[name: '*/main']], userRemoteConfigs: [[url: 'https://github.com/snyk-labs/nodejs-goof.git']], extensions: [[$class: 'CloneOption', depth: 1, shallow: true]]])
        }
      }
    }

    stage('Install • Test • Coverage • Audit') {
      steps {
        nodejs(nodeJSInstallationName: 'node18') {
          dir('app') {
            sh '''
              node -v
              npm -v
              npm ci || npm install
              npm test || true
              npm run coverage || true
              npm audit || true
            '''
          }
        }
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'app/coverage/**,app/npm-debug.log', allowEmptyArchive: true
    }
  }
}
