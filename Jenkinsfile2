pipeline {
  agent any
  triggers { pollSCM('H/5 * * * *') }

  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Install • Test • Coverage • Audit') {
      steps {
        nodejs(nodeJSInstallationName: 'node18') {
          sh '''
            node -v
            npm -v
            npm ci || npm install
            npm test || true
            npm run coverage || true
            npm audit || true
          '''
        }
      }
    }
  }

  post {
    always {
      // ok if coverage doesn't exist
      archiveArtifacts artifacts: 'coverage/**,npm-debug.log', allowEmptyArchive: true
    }
  }
}
